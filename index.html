<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>FOLDER</title>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #f7f9fa; font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif; }
    .container { max-width: 800px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 12px #0001; padding: 32px; }
    .toolbar { margin-bottom: 24px; }
    .file-list, .preview-list { margin-top: 24px; }
    .file-item, .preview-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
    .file-icon { font-size: 24px; margin-right: 12px; }
    .file-meta { flex: 1; }
    .file-actions button { margin-left: 8px; }
    .search-bar { margin-bottom: 16px; }
    .progress { height: 20px; margin-top: 8px; display: none; }
    .stats { margin-top: 24px; font-size: 15px; color: #888; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4 text-center">Dingfilestorage - æ··åˆä¸Šä¼ é¢„è§ˆ+æäº¤</h1>
    <div id="messageBar" style="display:none;" class="alert" role="alert"></div>

    <div class="toolbar d-flex flex-wrap align-items-center gap-2">
      <!-- å•æ–‡ä»¶å¤šé€‰ä¸Šä¼  -->
      <input type="file" id="singleFileInput" class="form-control" style="max-width:220px; display:none;" multiple />
      <button class="btn btn-primary" onclick="document.getElementById('singleFileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
      
      <!-- æ–‡ä»¶å¤¹ä¸Šä¼  -->
      <input type="file" id="folderInput" class="form-control" style="max-width:220px; display:none;" multiple webkitdirectory />
      <button class="btn btn-success" onclick="document.getElementById('folderInput').click()">é€‰æ‹©æ–‡ä»¶å¤¹</button>
      
      <!-- å¤‡æ³¨ -->
      <input type="text" id="remarkInput" class="form-control" placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼Œåº”ç”¨äºæ‰€æœ‰å¾…ä¸Šä¼ æ–‡ä»¶ï¼‰" style="max-width: 300px;" />
      
      <!-- æäº¤ä¸Šä¼ æŒ‰é’® -->
      <button class="btn btn-warning" id="uploadAllBtn" disabled>æäº¤ä¸Šä¼ </button>

      <div class="progress" id="uploadProgress">
        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
      </div>
    </div>

    <!-- é¢„è§ˆå¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ -->
    <h2>å¾…ä¸Šä¼ æ–‡ä»¶é¢„è§ˆ</h2>
    <div id="previewList" class="preview-list"><div class="text-muted">æš‚æ— å¾…ä¸Šä¼ æ–‡ä»¶</div></div>

    <!-- æœç´¢å·²ä¸Šä¼ æ–‡ä»¶ -->
    <div class="search-bar">
      <input type="text" id="searchInput" class="form-control" placeholder="æœç´¢æ–‡ä»¶åæˆ–å¤‡æ³¨..." oninput="filterFiles()" />
    </div>

    <h2>å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨</h2>
    <div id="fileList" class="file-list"><div class="text-muted">åŠ è½½ä¸­...</div></div>
    <div class="stats" id="stats"></div>
  </div>

  <script>
    // åˆå§‹åŒ– LeanCloud
    AV.init({
      appId: 'NOFmKbH8ZcIJX95z7f7lT7NR-MdYXbMMI',
      appKey: 'tu5Qw7cHQjkCbBQ7JmjlSdwf',
      serverURLs: 'https://nofmkbh8.api.lncldglobal.com'
    });

    let allFiles = [];  // å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
    let previewFiles = [];  // å¾…ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨

    // æ–‡ä»¶ç±»å‹å›¾æ ‡
    function getFileIcon(name) {
      const ext = name.split('.').pop().toLowerCase();
      if(['doc','docx'].includes(ext)) return 'ğŸ“„';
      if(['xls','xlsx'].includes(ext)) return 'ğŸ“Š';
      if(['ppt','pptx'].includes(ext)) return 'ğŸ“ˆ';
      if(['pdf'].includes(ext)) return 'ğŸ“•';
      if(['jpg','jpeg','png','gif','bmp'].includes(ext)) return 'ğŸ–¼ï¸';
      if(['zip','rar','7z'].includes(ext)) return 'ğŸ—œï¸';
      if(['mp4','avi','mov','wmv'].includes(ext)) return 'ğŸ¬';
      if(['mp3','wav','flac'].includes(ext)) return 'ğŸµ';
      return 'ğŸ“';
    }

    // é¢„è§ˆæ·»åŠ æ–‡ä»¶
    function addPreviewFiles(files) {
      let addedCount = 0;
      for (const file of files) {
        // é¿å…é‡å¤åŠ å…¥
        if (previewFiles.some(f => f.name === file.name && f.size === file.size)) {
          showMessage('warning', `æ–‡ä»¶ ${file.name} å·²åœ¨å¾…ä¸Šä¼ åˆ—è¡¨ä¸­`);
          continue;
        }
        // å¦‚æœå·²ä¸Šä¼ åˆ—è¡¨ä¸­æœ‰åŒåæ–‡ä»¶ï¼Œä¸é˜»æ­¢é¢„è§ˆï¼Œä½†ä¸Šä¼ æ—¶ä¼šåˆ¤æ–­
        previewFiles.push(file);
        addedCount++;
      }
      if(addedCount === 0) return;
      renderPreview();
      document.getElementById('uploadAllBtn').disabled = false;
    }

    // æ¸²æŸ“é¢„è§ˆåˆ—è¡¨
    function renderPreview() {
      const previewList = document.getElementById('previewList');
      previewList.innerHTML = '';
      if (previewFiles.length === 0) {
        previewList.innerHTML = '<div class="text-muted">æš‚æ— å¾…ä¸Šä¼ æ–‡ä»¶</div>';
        document.getElementById('uploadAllBtn').disabled = true;
        return;
      }
      previewFiles.forEach((file, idx) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        div.innerHTML = `
          <span class="file-icon">${getFileIcon(file.name)}</span>
          <div class="file-meta">
            <strong>${file.name}</strong>
            <div class="text-muted" style="font-size:13px;">å¤§å°: ${(file.size/1024).toFixed(2)} KB</div>
          </div>
          <div class="file-actions">
            <button class="btn btn-outline-danger btn-sm" onclick="removePreviewFile(${idx})">ç§»é™¤</button>
          </div>
        `;
        previewList.appendChild(div);
      });
    }

    // ä»é¢„è§ˆåˆ—è¡¨ç§»é™¤æ–‡ä»¶
    function removePreviewFile(index) {
      previewFiles.splice(index, 1);
      renderPreview();
    }

    // æäº¤ä¸Šä¼ æ‰€æœ‰é¢„è§ˆæ–‡ä»¶
    async function uploadAllFiles() {
      if (previewFiles.length === 0) {
        showMessage('warning', 'æ²¡æœ‰å¾…ä¸Šä¼ æ–‡ä»¶');
        return;
      }
      const remark = document.getElementById('remarkInput').value.trim();

      document.getElementById('uploadProgress').style.display = 'block';
      let uploadedCount = 0;

      for (let i = 0; i < previewFiles.length; i++) {
        const file = previewFiles[i];
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒåæ–‡ä»¶
        const query = new AV.Query('study');
        query.equalTo('name', file.name);
        const exist = await query.first();
        if (exist) {
          showMessage('warning', `æ–‡ä»¶ ${file.name} å·²å­˜åœ¨ï¼Œè·³è¿‡ä¸Šä¼ `);
          continue;
        }

        const avFile = new AV.File(file.name, file);
        const acl = new AV.ACL();
        acl.setPublicReadAccess(true);
        avFile.setACL(acl);

        try {
          await avFile.save({
            keepFileName: true,
            onprogress: function(percent) {
              const bar = document.getElementById('progressBar');
              bar.style.width = ((i + percent / 100) / previewFiles.length * 100) + '%';
              bar.textContent = `ä¸Šä¼ ä¸­ï¼š${file.name} (${percent.toFixed(0)}%)`;
            }
          });

          // ä¿å­˜å…ƒæ•°æ®
          const meta = new AV.Object('study');
          meta.set('name', avFile.get('name'));
          meta.set('url', avFile.get('url'));
          meta.set('remark', remark);
          const metaAcl = new AV.ACL();
          metaAcl.setPublicReadAccess(true);
          metaAcl.setPublicWriteAccess(true);
          meta.setACL(metaAcl);
          await meta.save();

          uploadedCount++;
        } catch (e) {
          showMessage('danger', `ä¸Šä¼ å¤±è´¥: ${file.name}`);
        }
      }

      showProgressBar('success', `ä¸Šä¼ å®Œæˆï¼š${uploadedCount} / ${previewFiles.length} ä¸ªæ–‡ä»¶`);
      previewFiles = [];
      renderPreview();
      document.getElementById('remarkInput').value = '';
      document.getElementById('uploadAllBtn').disabled = true;
      loadFiles();
    }

    // åŠ è½½å·²ä¸Šä¼ æ–‡ä»¶
    async function loadFiles() {
      const query = new AV.Query('study');
      query.descending('createdAt');
      const files = await query.find();

      allFiles = files.map(f => ({
        id: f.id,
        name: f.get('name'),
        url: f.get('url'),
        createdAt: f.createdAt,
        remark: f.get('remark') || ''
      }));

      renderFiles(allFiles);
      updateStats();
    }

    // æ¸²æŸ“å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
    function renderFiles(files) {
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';
      if (files.length === 0) {
        fileList.innerHTML = '<div class="text-muted">æš‚æ— æ–‡ä»¶</div>';
        return;
      }
      files.forEach(f => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
          <span class="file-icon">${getFileIcon(f.name)}</span>
          <div class="file-meta">
            <strong>${f.name}</strong>
            <span class="text-secondary ms-2">${f.remark ? 'å¤‡æ³¨ï¼š' + f.remark : ''}</span>
            <div class="text-muted" style="font-size:13px;">ä¸Šä¼ æ—¶é—´ï¼š${f.createdAt.toLocaleString()}</div>
          </div>
          <div class="file-actions">
            <a href="${f.url}" download class="btn btn-outline-success btn-sm">ä¸‹è½½</a>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('${f.id}')">åˆ é™¤</button>
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    // åˆ é™¤æ–‡ä»¶åŠè®°å½•
    async function deleteFile(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ–‡ä»¶å—ï¼Ÿ')) return;
      document.getElementById('uploadProgress').style.display = 'block';
      const bar = document.getElementById('progressBar');
      bar.style.width = '50%';
      bar.textContent = 'æ­£åœ¨åˆ é™¤...';
      try {
        const meta = AV.Object.createWithoutData('study', id);
        await meta.destroy();
        showProgressBar('success', 'åˆ é™¤æˆåŠŸ');
        loadFiles();
      } catch {
        showProgressBar('error', 'åˆ é™¤å¤±è´¥');
      }
    }

    // æœç´¢è¿‡æ»¤
    function filterFiles() {
      const kw = document.getElementById('searchInput').value.trim();
      if (!kw) return renderFiles(allFiles);
      const filtered = allFiles.filter(f =>
        f.name.includes(kw) || (f.remark && f.remark.includes(kw))
      );
      renderFiles(filtered);
    }

    // æ–‡ä»¶ç»Ÿè®¡
    function updateStats() {
      const stats = document.getElementById('stats');
      stats.innerHTML = `å…± <b>${allFiles.length}</b> ä¸ªæ–‡ä»¶ï¼Œæœ€è¿‘ä¸Šä¼ ï¼š${allFiles[0]?.createdAt.toLocaleString() || 'æ— '}`;
    }

    // ä¸Šä¼ è¿›åº¦æ¡æ˜¾ç¤º
    function showProgressBar(status, text) {
      const bar = document.getElementById('progressBar');
      bar.style.width = '100%';
      bar.textContent = text;
      bar.className = 'progress-bar ' + (status === 'success' ? 'bg-success' : 'bg-danger');
      setTimeout(() => {
        bar.style.width = '0%';
        bar.textContent = '';
        bar.className = 'progress-bar';
        document.getElementById('uploadProgress').style.display = 'none';
      }, 2000);
    }

    // æ¶ˆæ¯æç¤º
    function showMessage(type, text) {
      const bar = document.getElementById('messageBar');
      bar.className = 'alert alert-' + type;
      bar.textContent = text;
      bar.style.display = 'block';
      setTimeout(() => {
        bar.style.display = 'none';
      }, 2500);
    }

    // äº‹ä»¶ç»‘å®š
    document.getElementById('singleFileInput').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        addPreviewFiles(e.target.files);
      }
      e.target.value = '';
    });

    document.getElementById('folderInput').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        addPreviewFiles(e.target.files);
      }
      e.target.value = '';
    });

    document.getElementById('uploadAllBtn').addEventListener('click', uploadAllFiles);

    // é¡µé¢åŠ è½½åˆå§‹åŒ–
    loadFiles();
  </script>
</body>
</html>
