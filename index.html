<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>file storage </title>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f7f9fa;
      font-family: "微软雅黑", Arial, sans-serif;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
      padding: 32px;
    }
    .toolbar {
      margin-bottom: 24px;
    }
    .file-list {
      margin-top: 24px;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .file-icon {
      font-size: 24px;
      margin-right: 12px;
    }
    .file-meta {
      flex: 1;
    }
    .file-actions button {
      margin-left: 8px;
    }
    .search-bar {
      margin-bottom: 16px;
    }
    .progress {
      height: 20px;
      margin-top: 8px;
      display: none;
    }
    .stats {
      margin-top: 24px;
      font-size: 15px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4 text-center">Dingfilestorage - 混合上传模式</h1>
    <div id="messageBar" style="display:none;" class="alert" role="alert"></div>

    <div class="toolbar d-flex flex-wrap align-items-center gap-2">
      <!-- 混合文件和文件夹选择 -->
      <input
        type="file"
        id="mixedInput"
        class="form-control"
        style="max-width: 320px; display: none"
        multiple
        webkitdirectory
      />
      <button
        class="btn btn-primary"
        onclick="document.getElementById('mixedInput').click()"
      >
        选择文件或文件夹
      </button>

      <button class="btn btn-success" id="uploadBtn" disabled>提交上传</button>

      <input
        type="text"
        id="remarkInput"
        class="form-control"
        placeholder="备注（可选）"
        style="max-width: 180px"
      />

      <div class="progress" id="uploadProgress">
        <div
          class="progress-bar"
          id="progressBar"
          role="progressbar"
          style="width: 0%"
        ></div>
      </div>
    </div>

    <div class="search-bar">
      <input
        type="text"
        id="searchInput"
        class="form-control"
        placeholder="搜索文件名或备注..."
        oninput="filterFiles()"
      />
    </div>

    <h2 class="mt-4">文件列表</h2>
    <div id="fileList" class="file-list"></div>
    <div class="stats" id="stats"></div>
  </div>

  <script>
    // 初始化 LeanCloud
    AV.init({
      appId: "NOFmKbH8ZcIJX95z7f7lT7NR-MdYXbMMI",
      appKey: "tu5Qw7cHQjkCbBQ7JmjlSdwf",
      serverURLs: "https://nofmkbh8.api.lncldglobal.com",
    });

    let allFiles = [];
    let selectedFiles = [];

    // 文件类型图标
    function getFileIcon(name) {
      const ext = name.split(".").pop().toLowerCase();
      if (["doc", "docx"].includes(ext)) return "📄";
      if (["xls", "xlsx"].includes(ext)) return "📊";
      if (["ppt", "pptx"].includes(ext)) return "📈";
      if (["pdf"].includes(ext)) return "📕";
      if (["jpg", "jpeg", "png", "gif", "bmp"].includes(ext)) return "🖼️";
      if (["zip", "rar", "7z"].includes(ext)) return "🗜️";
      if (["mp4", "avi", "mov", "wmv"].includes(ext)) return "🎬";
      if (["mp3", "wav", "flac"].includes(ext)) return "🎵";
      return "📁";
    }

    // 选择文件或文件夹时触发
    document
      .getElementById("mixedInput")
      .addEventListener("change", function () {
        selectedFiles = Array.from(this.files);
        if (selectedFiles.length > 0) {
          document.getElementById("uploadBtn").disabled = false;
          renderPreview(selectedFiles);
        } else {
          document.getElementById("uploadBtn").disabled = true;
          clearPreview();
        }
      });

    // 上传按钮点击
    document
      .getElementById("uploadBtn")
      .addEventListener("click", async function () {
        const remark = document.getElementById("remarkInput").value.trim();
        if (selectedFiles.length === 0) {
          showMessage("warning", "请选择文件或文件夹");
          return;
        }
        this.disabled = true;
        await uploadFiles(selectedFiles, remark);
        selectedFiles = [];
        clearPreview();
        this.disabled = true;
        document.getElementById("mixedInput").value = "";
        document.getElementById("remarkInput").value = "";
        loadFiles();
      });

    // 预览选中文件
    function renderPreview(files) {
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "<h3>待上传文件预览：</h3>";
      files.forEach((f) => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `
          <span class="file-icon">${getFileIcon(f.name)}</span>
          <div class="file-meta">
            <strong>${f.name}</strong>
            <div class="text-muted" style="font-size:13px;">大小：${(
              f.size /
              1024
            ).toFixed(1)} KB</div>
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    function clearPreview() {
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "";
    }

    // 上传文件函数（批量）
    async function uploadFiles(files, remark) {
      document.getElementById("uploadProgress").style.display = "block";
      const progressBar = document.getElementById("progressBar");
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        // 检查是否已存在同名文件
        const query = new AV.Query("study");
        query.equalTo("name", file.name);
        const exist = await query.first();
        if (exist) {
          showMessage("warning", `文件 ${file.name} 已存在，禁止重复上传`);
          continue;
        }
        const avFile = new AV.File(file.name, file);
        // 设置公开读取权限
        const acl = new AV.ACL();
        acl.setPublicReadAccess(true);
        avFile.setACL(acl);

        await avFile
          .save({
            keepFileName: true,
            onprogress: function (percent) {
              const percentAll = ((i + percent / 100) / files.length) * 100;
              progressBar.style.width = percentAll + "%";
            },
          })
          .then(async (savedFile) => {
            const meta = new AV.Object("study");
            meta.set("name", savedFile.get("name"));
            meta.set("url", savedFile.get("url"));
            meta.set("remark", remark);
            const metaAcl = new AV.ACL();
            metaAcl.setPublicReadAccess(true);
            metaAcl.setPublicWriteAccess(true);
            meta.setACL(metaAcl);
            await meta.save();
            showProgressBar("success", `上传成功: ${savedFile.get("name")}`);
          })
          .catch(() => {
            showProgressBar("error", `上传失败: ${file.name}`);
          });
      }
      progressBar.style.width = "0%";
      document.getElementById("uploadProgress").style.display = "none";
    }

    // 加载已有文件
    async function loadFiles() {
      const query = new AV.Query("study");
      query.descending("createdAt");
      const files = await query.find();

      allFiles = files.map((f) => ({
        id: f.id,
        name: f.get("name"),
        url: f.get("url"),
        createdAt: f.createdAt,
        remark: f.get("remark") || "",
      }));

      renderFiles(allFiles);
      updateStats();
    }

    // 渲染文件列表
    function renderFiles(files) {
      const fileList = document.getElementById("fileList");
      if (selectedFiles.length > 0) return; // 如果预览状态，不显示已上传文件列表

      fileList.innerHTML = "";
      if (files.length === 0) {
        fileList.innerHTML = '<div class="text-muted">暂无文件</div>';
        return;
      }
      files.forEach((f) => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `
          <span class="file-icon">${getFileIcon(f.name)}</span>
          <div class="file-meta">
            <strong>${f.name}</strong>
            <span class="text-secondary ms-2">${
              f.remark ? "备注：" + f.remark : ""
            }</span>
            <div class="text-muted" style="font-size:13px;">上传时间：${f.createdAt.toLocaleString()}</div>
          </div>
          <div class="file-actions">
            <a href="${f.url}" download class="btn btn-outline-success btn-sm">下载</a>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('${f.id}')">删除</button>
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    // 删除文件
    async function deleteFile(id) {
      if (!confirm("确定要删除该文件吗？")) return;
      document.getElementById("uploadProgress").style.display = "block";
      const progressBar = document.getElementById("progressBar");
      progressBar.style.width = "50%";
      progressBar.textContent = "正在删除...";
      try {
        const meta = AV.Object.createWithoutData("study", id);
        await meta.destroy();
        showProgressBar("success", "删除成功");
        loadFiles();
      } catch {
        showProgressBar("error", "删除失败");
      }
    }

    // 搜索过滤
    function filterFiles() {
      const kw = document.getElementById("searchInput").value.trim();
      if (!kw) return renderFiles(allFiles);
      const filtered = allFiles.filter(
        (f) => f.name.includes(kw) || (f.remark && f.remark.includes(kw))
      );
      renderFiles(filtered);
    }

    // 统计信息
    function updateStats() {
      const stats = document.getElementById("stats");
      stats.innerHTML = `共 <b>${allFiles.length}</b> 个文件，最近上传：${allFiles[0]?.createdAt.toLocaleString() || "无"}`;
    }

    // 显示进度条状态
    function showProgressBar(status, text) {
      const bar = document.getElementById("progressBar");
      bar.style.width = "100%";
      bar.textContent = text;
      bar.className = "progress-bar " + (status === "success" ? "bg-success" : "bg-danger");
      setTimeout(() => {
        bar.style.width = "0%";
        bar.textContent = "";
        bar.className = "progress-bar";
        document.getElementById("uploadProgress").style.display = "none";
      }, 1500);
    }

    // 显示提示消息
    function showMessage(type, text) {
      const bar = document.getElementById("messageBar");
      bar.className = "alert alert-" + type;
      bar.textContent = text;
      bar.style.display = "block";
      setTimeout(() => {
        bar.style.display = "none";
      }, 2000);
    }

    // 初始化页面时加载文件列表
    loadFiles();
  </script>
</body>
</html>
