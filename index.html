<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>file storage </title>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4/dist/av-min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: #f7f9fa;
      font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #0001;
      padding: 32px;
    }
    .toolbar {
      margin-bottom: 24px;
    }
    .file-list {
      margin-top: 24px;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .file-icon {
      font-size: 24px;
      margin-right: 12px;
    }
    .file-meta {
      flex: 1;
    }
    .file-actions button {
      margin-left: 8px;
    }
    .search-bar {
      margin-bottom: 16px;
    }
    .progress {
      height: 20px;
      margin-top: 8px;
      display: none;
    }
    .stats {
      margin-top: 24px;
      font-size: 15px;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4 text-center">Dingfilestorage - æ··åˆä¸Šä¼ æ¨¡å¼</h1>
    <div id="messageBar" style="display:none;" class="alert" role="alert"></div>

    <div class="toolbar d-flex flex-wrap align-items-center gap-2">
      <!-- æ··åˆæ–‡ä»¶å’Œæ–‡ä»¶å¤¹é€‰æ‹© -->
      <input
        type="file"
        id="mixedInput"
        class="form-control"
        style="max-width: 320px; display: none"
        multiple
        webkitdirectory
      />
      <button
        class="btn btn-primary"
        onclick="document.getElementById('mixedInput').click()"
      >
        é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
      </button>

      <button class="btn btn-success" id="uploadBtn" disabled>æäº¤ä¸Šä¼ </button>

      <input
        type="text"
        id="remarkInput"
        class="form-control"
        placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"
        style="max-width: 180px"
      />

      <div class="progress" id="uploadProgress">
        <div
          class="progress-bar"
          id="progressBar"
          role="progressbar"
          style="width: 0%"
        ></div>
      </div>
    </div>

    <div class="search-bar">
      <input
        type="text"
        id="searchInput"
        class="form-control"
        placeholder="æœç´¢æ–‡ä»¶åæˆ–å¤‡æ³¨..."
        oninput="filterFiles()"
      />
    </div>

    <h2 class="mt-4">æ–‡ä»¶åˆ—è¡¨</h2>
    <div id="fileList" class="file-list"></div>
    <div class="stats" id="stats"></div>
  </div>

  <script>
    // åˆå§‹åŒ– LeanCloud
    AV.init({
      appId: "NOFmKbH8ZcIJX95z7f7lT7NR-MdYXbMMI",
      appKey: "tu5Qw7cHQjkCbBQ7JmjlSdwf",
      serverURLs: "https://nofmkbh8.api.lncldglobal.com",
    });

    let allFiles = [];
    let selectedFiles = [];

    // æ–‡ä»¶ç±»å‹å›¾æ ‡
    function getFileIcon(name) {
      const ext = name.split(".").pop().toLowerCase();
      if (["doc", "docx"].includes(ext)) return "ğŸ“„";
      if (["xls", "xlsx"].includes(ext)) return "ğŸ“Š";
      if (["ppt", "pptx"].includes(ext)) return "ğŸ“ˆ";
      if (["pdf"].includes(ext)) return "ğŸ“•";
      if (["jpg", "jpeg", "png", "gif", "bmp"].includes(ext)) return "ğŸ–¼ï¸";
      if (["zip", "rar", "7z"].includes(ext)) return "ğŸ—œï¸";
      if (["mp4", "avi", "mov", "wmv"].includes(ext)) return "ğŸ¬";
      if (["mp3", "wav", "flac"].includes(ext)) return "ğŸµ";
      return "ğŸ“";
    }

    // é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹æ—¶è§¦å‘
    document
      .getElementById("mixedInput")
      .addEventListener("change", function () {
        selectedFiles = Array.from(this.files);
        if (selectedFiles.length > 0) {
          document.getElementById("uploadBtn").disabled = false;
          renderPreview(selectedFiles);
        } else {
          document.getElementById("uploadBtn").disabled = true;
          clearPreview();
        }
      });

    // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»
    document
      .getElementById("uploadBtn")
      .addEventListener("click", async function () {
        const remark = document.getElementById("remarkInput").value.trim();
        if (selectedFiles.length === 0) {
          showMessage("warning", "è¯·é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹");
          return;
        }
        this.disabled = true;
        await uploadFiles(selectedFiles, remark);
        selectedFiles = [];
        clearPreview();
        this.disabled = true;
        document.getElementById("mixedInput").value = "";
        document.getElementById("remarkInput").value = "";
        loadFiles();
      });

    // é¢„è§ˆé€‰ä¸­æ–‡ä»¶
    function renderPreview(files) {
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "<h3>å¾…ä¸Šä¼ æ–‡ä»¶é¢„è§ˆï¼š</h3>";
      files.forEach((f) => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `
          <span class="file-icon">${getFileIcon(f.name)}</span>
          <div class="file-meta">
            <strong>${f.name}</strong>
            <div class="text-muted" style="font-size:13px;">å¤§å°ï¼š${(
              f.size /
              1024
            ).toFixed(1)} KB</div>
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    function clearPreview() {
      const fileList = document.getElementById("fileList");
      fileList.innerHTML = "";
    }

    // ä¸Šä¼ æ–‡ä»¶å‡½æ•°ï¼ˆæ‰¹é‡ï¼‰
    async function uploadFiles(files, remark) {
      document.getElementById("uploadProgress").style.display = "block";
      const progressBar = document.getElementById("progressBar");
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
        const query = new AV.Query("study");
        query.equalTo("name", file.name);
        const exist = await query.first();
        if (exist) {
          showMessage("warning", `æ–‡ä»¶ ${file.name} å·²å­˜åœ¨ï¼Œç¦æ­¢é‡å¤ä¸Šä¼ `);
          continue;
        }
        const avFile = new AV.File(file.name, file);
        // è®¾ç½®å…¬å¼€è¯»å–æƒé™
        const acl = new AV.ACL();
        acl.setPublicReadAccess(true);
        avFile.setACL(acl);

        await avFile
          .save({
            keepFileName: true,
            onprogress: function (percent) {
              const percentAll = ((i + percent / 100) / files.length) * 100;
              progressBar.style.width = percentAll + "%";
            },
          })
          .then(async (savedFile) => {
            const meta = new AV.Object("study");
            meta.set("name", savedFile.get("name"));
            meta.set("url", savedFile.get("url"));
            meta.set("remark", remark);
            const metaAcl = new AV.ACL();
            metaAcl.setPublicReadAccess(true);
            metaAcl.setPublicWriteAccess(true);
            meta.setACL(metaAcl);
            await meta.save();
            showProgressBar("success", `ä¸Šä¼ æˆåŠŸ: ${savedFile.get("name")}`);
          })
          .catch(() => {
            showProgressBar("error", `ä¸Šä¼ å¤±è´¥: ${file.name}`);
          });
      }
      progressBar.style.width = "0%";
      document.getElementById("uploadProgress").style.display = "none";
    }

    // åŠ è½½å·²æœ‰æ–‡ä»¶
    async function loadFiles() {
      const query = new AV.Query("study");
      query.descending("createdAt");
      const files = await query.find();

      allFiles = files.map((f) => ({
        id: f.id,
        name: f.get("name"),
        url: f.get("url"),
        createdAt: f.createdAt,
        remark: f.get("remark") || "",
      }));

      renderFiles(allFiles);
      updateStats();
    }

    // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
    function renderFiles(files) {
      const fileList = document.getElementById("fileList");
      if (selectedFiles.length > 0) return; // å¦‚æœé¢„è§ˆçŠ¶æ€ï¼Œä¸æ˜¾ç¤ºå·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨

      fileList.innerHTML = "";
      if (files.length === 0) {
        fileList.innerHTML = '<div class="text-muted">æš‚æ— æ–‡ä»¶</div>';
        return;
      }
      files.forEach((f) => {
        const div = document.createElement("div");
        div.className = "file-item";
        div.innerHTML = `
          <span class="file-icon">${getFileIcon(f.name)}</span>
          <div class="file-meta">
            <strong>${f.name}</strong>
            <span class="text-secondary ms-2">${
              f.remark ? "å¤‡æ³¨ï¼š" + f.remark : ""
            }</span>
            <div class="text-muted" style="font-size:13px;">ä¸Šä¼ æ—¶é—´ï¼š${f.createdAt.toLocaleString()}</div>
          </div>
          <div class="file-actions">
            <a href="${f.url}" download class="btn btn-outline-success btn-sm">ä¸‹è½½</a>
            <button class="btn btn-outline-danger btn-sm" onclick="deleteFile('${f.id}')">åˆ é™¤</button>
          </div>
        `;
        fileList.appendChild(div);
      });
    }

    // åˆ é™¤æ–‡ä»¶
    async function deleteFile(id) {
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥æ–‡ä»¶å—ï¼Ÿ")) return;
      document.getElementById("uploadProgress").style.display = "block";
      const progressBar = document.getElementById("progressBar");
      progressBar.style.width = "50%";
      progressBar.textContent = "æ­£åœ¨åˆ é™¤...";
      try {
        const meta = AV.Object.createWithoutData("study", id);
        await meta.destroy();
        showProgressBar("success", "åˆ é™¤æˆåŠŸ");
        loadFiles();
      } catch {
        showProgressBar("error", "åˆ é™¤å¤±è´¥");
      }
    }

    // æœç´¢è¿‡æ»¤
    function filterFiles() {
      const kw = document.getElementById("searchInput").value.trim();
      if (!kw) return renderFiles(allFiles);
      const filtered = allFiles.filter(
        (f) => f.name.includes(kw) || (f.remark && f.remark.includes(kw))
      );
      renderFiles(filtered);
    }

    // ç»Ÿè®¡ä¿¡æ¯
    function updateStats() {
      const stats = document.getElementById("stats");
      stats.innerHTML = `å…± <b>${allFiles.length}</b> ä¸ªæ–‡ä»¶ï¼Œæœ€è¿‘ä¸Šä¼ ï¼š${allFiles[0]?.createdAt.toLocaleString() || "æ— "}`;
    }

    // æ˜¾ç¤ºè¿›åº¦æ¡çŠ¶æ€
    function showProgressBar(status, text) {
      const bar = document.getElementById("progressBar");
      bar.style.width = "100%";
      bar.textContent = text;
      bar.className = "progress-bar " + (status === "success" ? "bg-success" : "bg-danger");
      setTimeout(() => {
        bar.style.width = "0%";
        bar.textContent = "";
        bar.className = "progress-bar";
        document.getElementById("uploadProgress").style.display = "none";
      }, 1500);
    }

    // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
    function showMessage(type, text) {
      const bar = document.getElementById("messageBar");
      bar.className = "alert alert-" + type;
      bar.textContent = text;
      bar.style.display = "block";
      setTimeout(() => {
        bar.style.display = "none";
      }, 2000);
    }

    // åˆå§‹åŒ–é¡µé¢æ—¶åŠ è½½æ–‡ä»¶åˆ—è¡¨
    loadFiles();
  </script>
</body>
</html>
